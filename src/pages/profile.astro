---
import FrontPageLayout from "../layouts/FrontPageLayout.astro";
import ProfileViewer from "../components/profile/ProfileViewer.svelte";

// OPTIMIZATION: Import Redis caching utilities
import { getCached, setCached, cacheKey, CACHE_TTL, deleteCached } from '../lib/redis';

// Get user ID from query params (e.g., /profile?id=35)
// If no ID provided, show the logged-in user's profile
const userId = Astro.url.searchParams.get('id');
const forceRefresh = Astro.url.searchParams.get('refresh') === '1';

let profileUser = null;
let initialError = null;
let isOwnProfile = false;

// Get the auth token from the request cookies on the server
const token = Astro.cookies.get('payload-token')?.value;

// Performance timing
const perfStart = performance.now();
console.log('[Profile SSR] Starting profile page load');

try {
  if (userId) {
    // Fetch specific user profile
    const userCacheKey = cacheKey.user(parseInt(userId));

    // Invalidate cache if refresh is requested
    if (forceRefresh) {
      console.log(`[Profile SSR] Force refresh requested for user ${userId}`);
      await deleteCached(userCacheKey);
    }

    const cachedUser = await getCached<any>(userCacheKey);

    if (cachedUser && !forceRefresh) {
      console.log(`[Profile SSR] Cache HIT for user ${userId}`, {
        hasHeaderImage: !!cachedUser.headerImage,
        headerImageUrl: cachedUser.headerImage?.url
      });
      profileUser = cachedUser;
    } else {
      console.log(`[Profile SSR] Cache MISS for user ${userId} - fetching from API`);

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);

      try {
        const response = await fetch(
          `${import.meta.env.PUBLIC_PAYLOAD_URL}/api/users/${userId}?depth=3`,
          { signal: controller.signal }
        );
        clearTimeout(timeoutId);

        if (response.ok) {
          profileUser = await response.json();
          console.log('[Profile SSR] Fetched user data:', {
            id: profileUser.id,
            hasHeaderImage: !!profileUser.headerImage,
            headerImageUrl: profileUser.headerImage?.url
          });
          // Cache the result
          setCached(userCacheKey, profileUser, CACHE_TTL.USERS);
        } else if (response.status === 404) {
          initialError = 'User not found';
        } else {
          initialError = 'Failed to load profile';
        }
      } catch (fetchError: any) {
        clearTimeout(timeoutId);
        if (fetchError.name === 'AbortError') {
          console.warn('[Profile SSR] Fetch timed out');
          initialError = 'Request timed out';
        } else {
          throw fetchError;
        }
      }
    }

    // Check if viewing own profile
    if (token && profileUser) {
      try {
        const meResponse = await fetch(
          `${import.meta.env.PUBLIC_PAYLOAD_URL}/api/users/me?depth=3`,
          {
            headers: { 'Cookie': `payload-token=${token}` }
          }
        );
        if (meResponse.ok) {
          const meData = await meResponse.json();
          const currentUser = meData.user || meData;
          isOwnProfile = currentUser.id === profileUser.id;
        }
      } catch (e) {
        // Ignore errors checking own profile
      }
    }
  } else if (token) {
    // Fetch logged-in user's profile
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    try {
      const response = await fetch(
        `${import.meta.env.PUBLIC_PAYLOAD_URL}/api/users/me?depth=3`,
        {
          headers: {
            'Cookie': `payload-token=${token}`
          },
          signal: controller.signal
        }
      );
      clearTimeout(timeoutId);

      if (response.ok) {
        const data = await response.json();
        profileUser = data.user || data;
        isOwnProfile = true;
      } else {
        initialError = 'Please log in to view your profile';
      }
    } catch (fetchError: any) {
      clearTimeout(timeoutId);
      if (fetchError.name === 'AbortError') {
        console.warn('[Profile SSR] Fetch timed out');
      }
      initialError = 'Failed to load profile';
    }
  } else {
    initialError = 'Please log in to view your profile or provide a user ID';
  }
} catch (error) {
  console.error('[Profile SSR] Error:', error);
  initialError = 'An error occurred while loading the profile';
}

const perfEnd = performance.now();
console.log(`[Profile SSR] Total processing time: ${(perfEnd - perfStart).toFixed(0)}ms`);

// Get display name for the page title
const pageTitle = profileUser?.displayName
  ? `${profileUser.displayName}'s Profile`
  : 'Profile';
---

<FrontPageLayout title={pageTitle}>
  <div class="profile-page-container">
    <ProfileViewer
      client:only="svelte"
      initialUser={profileUser}
      initialError={initialError}
      userId={userId ? parseInt(userId) : null}
      isOwnProfile={isOwnProfile}
    />
  </div>
</FrontPageLayout>

<style>
  .profile-page-container {
    width: 1202px;
    max-width: 100%;
    margin: 0 auto;
    padding: 50px 0px;
  }

  @media (max-width: 1240px) {
    .profile-page-container {
      width: 90%;
    }
  }

  @media (max-width: 768px) {
    .profile-page-container {
      width: 100%;
      padding: 20px 10px;
    }
  }
</style>
