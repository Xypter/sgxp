---
import FrontPageLayout from '../../layouts/FrontPageLayout.astro';
import ConversationView from '@components/messages/ConversationView.svelte';

const { conversationId } = Astro.params;

// Auth check
const token = Astro.cookies.get('payload-token')?.value;

if (!token) {
  return Astro.redirect(`/login?redirect=/messages/${conversationId}`);
}

// Verify auth
let currentUser = null;
try {
  const payloadUrl = import.meta.env.PAYLOAD_URL;
  const response = await fetch(`${payloadUrl}/api/users/me`, {
    headers: { 'Cookie': `payload-token=${token}` }
  });

  if (response.ok) {
    const data = await response.json();
    currentUser = data.user || data;
  } else {
    return Astro.redirect(`/login?redirect=/messages/${conversationId}`);
  }
} catch (error) {
  console.error('[Conversation SSR] Auth check failed:', error);
  return Astro.redirect(`/login?redirect=/messages/${conversationId}`);
}
---

<FrontPageLayout title="Conversation - SGXP">
  <div class="conversation-page-container">
    {/* @ts-expect-error - Svelte 5 component props not recognized by Astro TypeScript */}
    <ConversationView conversationId={conversationId} user={currentUser} client:load />
  </div>
</FrontPageLayout>

<style>
  .conversation-page-container {
    width: 1202px;
    max-width: 100%;
    margin: 0 auto;
    padding: 50px 20px;
  }

  @media (max-width: 1250px) {
    .conversation-page-container {
      padding: 30px 15px;
    }
  }
</style>
