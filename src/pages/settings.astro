---
import FrontPageLayout from "../layouts/FrontPageLayout.astro";
import SettingsForm from "../components/settings/SettingsForm.svelte";

// Get the auth token from the request cookies on the server
const token = Astro.cookies.get('payload-token')?.value;

let currentUser = null;
let initialError = null;

// Performance timing
const perfStart = performance.now();
console.log('[Settings SSR] Starting settings page load');

// Must be logged in to access settings
if (!token) {
  return Astro.redirect('/login?redirect=/settings');
}

try {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  const response = await fetch(
    `${import.meta.env.PUBLIC_PAYLOAD_URL}/api/users/me`,
    {
      headers: {
        'Cookie': `payload-token=${token}`
      },
      signal: controller.signal
    }
  );
  clearTimeout(timeoutId);

  if (response.ok) {
    const data = await response.json();
    currentUser = data.user || data;
  } else {
    // Token invalid, redirect to login
    return Astro.redirect('/login?redirect=/settings');
  }
} catch (fetchError: any) {
  console.error('[Settings SSR] Error:', fetchError);
  if (fetchError.name === 'AbortError') {
    initialError = 'Request timed out. Please try again.';
  } else {
    initialError = 'Failed to load settings';
  }
}

const perfEnd = performance.now();
console.log(`[Settings SSR] Total processing time: ${(perfEnd - perfStart).toFixed(0)}ms`);
---

<FrontPageLayout title="Account Settings">
  <div class="settings-page-container">
    <SettingsForm
      client:only="svelte"
      initialUser={currentUser}
      initialError={initialError}
      authToken={token}
    />
  </div>
</FrontPageLayout>

<style>
  .settings-page-container {
    width: 70%;
    margin: 0 auto;
    padding: 50px 20px;
  }

  @media (max-width: 1200px) {
    .settings-page-container {
      width: 90%;
    }
  }

  @media (max-width: 768px) {
    .settings-page-container {
      width: 100%;
      padding: 20px 10px;
    }
  }
</style>
