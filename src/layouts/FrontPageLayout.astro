---
import "../styles/global.css";
import "../styles/sprite_icon.css";

// Remove main.css import for now to avoid conflicts
// import "../styles/main.css";

// Correct import statement to the .tsx file
import SGXPNavbar from "../components/Navbar.svelte";

// Import types from the .tsx file
import type { User, ThemeValue } from '../components/SGXPNavbar.tsx';

// Get the theme from the cookie during SSR to prevent flashing
const themeFromCookie = (Astro.cookies.get('theme')?.value as ThemeValue) || "style_v7";

let user: User | null = null;
// Get the auth token from the request cookies on the server
const token = Astro.cookies.get('payload-token')?.value;

// If the token exists, verify it by calling your Payload backend
if (token) {
  try {
    // Use the environment variable for the Payload URL
    const response = await fetch(`${import.meta.env.PUBLIC_PAYLOAD_URL}/api/users/me`, {
      headers: {
        // Forward the cookie to Payload for verification
        'Cookie': `payload-token=${token}`
      }
    });
    if (response.ok) {
      const data = await response.json();
      user = data.user || data; // Set the user object if the token is valid
    }
  } catch (error) {
    // Log the error on the server, but don't block the page from rendering
    console.error('SSR Auth Check Failed:', error);
  }
}

// Any other props for your layout
export interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!DOCTYPE html>
<!-- Set the data-theme attribute on the server based on the cookie -->
<html lang="en" class="dark" data-theme={themeFromCookie}>
<head>
  <script
    src="https://stats.sgxp.me:7443/api/script.js"
    data-site-id="1"
    defer
  ></script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>

  <!-- Load consolidated themes CSS -->
  <link rel="stylesheet" type="text/css" href="/themes.css">

  <!-- The theme loading script is no longer needed here as the theme is set on the server -->

  <link rel="icon" type="image/gif" href="/img/SGXPkanDos.gif" />
</head>
<body>
<!-- Pass the 'user' object to the initialUser prop -->
<SGXPNavbar client:load initialUser={user} baseURL={Astro.url.origin} initialTheme={themeFromCookie} />

  <div class="sonic-trigger" title="Click me!"></div>
  <script is:inline src="/js/arkanimation.js"></script>
  <slot>You're not supposed to see this LMAO</slot>
</body>
</html>
